<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LJY-GLM-4-Flash | 智能对话</title>

  <!-- 关键资源：Tailwind & FontAwesome（直接加载，不延迟） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- 其余延迟加载资源保持不变 -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css" media="print" onload="this.media='all'">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js" defer></script>
  <script src="https://unpkg.com/mammoth@1.4.21/mammoth.browser.min.js" defer></script>

<!-- 内联关键CSS -->
  <style>
    body { 
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      background-color: #0F1115; 
      color: #E5E7EB; 
      min-height: 100vh; 
      margin: 0; 
      overflow-x: hidden;
      transition: background-color 0.5s ease, color 0.5s ease;
    }

    /* 粒子背景 */
    #particleContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* === 全新首页动画 === */
    /* 背景渐变流动 */
    @keyframes backgroundFlow {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }

    /* 霓虹文字脉冲（调暗） */
    @keyframes neonPulse {
      0%, 100% {
        text-shadow: 
          0 0 5px #fff,
          0 0 10px #6366F1,
          0 0 15px #6366F1;
      }
      50% {
        text-shadow: 
          0 0 3px #fff,
          0 0 6px #6366F1,
          0 0 9px #6366F1;
      }
    }

    /* 3D旋转卡片 */
    @keyframes cardRotate {
      0% { transform: rotateY(0deg) rotateX(0deg); }
      25% { transform: rotateY(15deg) rotateX(5deg); }
      50% { transform: rotateY(0deg) rotateX(-5deg); }
      75% { transform: rotateY(-15deg) rotateX(5deg); }
      100% { transform: rotateY(0deg) rotateX(0deg); }
    }

    /* 波浪动画 */
    @keyframes waveFlow {
      0% { transform: translateX(-100%) translateY(0); }
      50% { transform: translateX(0) translateY(-20px); }
      100% { transform: translateX(100%) translateY(0); }
    }

    /* 闪烁星点 */
    @keyframes starTwinkle {
      0%, 100% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    /* 浮动上升 */
    @keyframes floatUp {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }

    /* 脉冲环 */
    @keyframes pulseRing {
      0% { transform: scale(0.8); opacity: 0.8; }
      100% { transform: scale(1.2); opacity: 0; }
    }

    .background-flow {
      background: linear-gradient(135deg, #0F1115, #1a1a2e, #16213e, #0f3460, #533483);
      background-size: 400% 400%;
      animation: backgroundFlow 15s ease infinite;
    }

    /* 调暗的霓虹文字 */
    .neon-text-dim {
      animation: neonPulse 2s ease-in-out infinite;
    }

    .card-3d {
      animation: cardRotate 8s ease-in-out infinite;
      transform-style: preserve-3d;
    }

    .wave-bg {
      position: absolute;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent 30%, rgba(99, 102, 241, 0.1) 50%, transparent 70%);
      animation: waveFlow 20s linear infinite;
    }

    .star-field {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: starTwinkle 3s ease-in-out infinite;
    }

    .floating-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, #6366F1, transparent);
      border-radius: 50%;
      animation: floatUp 10s linear infinite;
    }

    .pulse-ring {
      position: absolute;
      border: 2px solid rgba(99, 102, 241, 0.6);
      border-radius: 50%;
      animation: pulseRing 3s ease-out infinite;
    }

    /* 核心动画保留 */
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(10deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 50%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
      50% { box-shadow: 0 0 30px rgba(99, 102, 241, 0.8), 0 0 50px rgba(99, 102, 241, 0.4); }
    }

    @keyframes pulseScale {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slide {
      0% { transform: translateX(-100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-10px); }
    }

    @keyframes neonFlicker {
      0%, 100% { 
        text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #6366F1, 0 0 70px #6366F1, 0 0 80px #6366F1;
      }
      50% {
        text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fff, 0 0 20px #6366F1, 0 0 35px #6366F1, 0 0 40px #6366F1;
      }
    }

    @keyframes wave {
      0% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-5px) rotate(5deg); }
      50% { transform: translateY(-10px) rotate(0deg); }
      75% { transform: translateY(-5px) rotate(-5deg); }
      100% { transform: translateY(0px) rotate(0deg); }
    }

    @keyframes glowText {
      0%, 100% { 
        filter: brightness(1) contrast(1);
      }
      50% { 
        filter: brightness(1.2) contrast(1.1);
      }
    }

    .animate-float {
      animation: float 6s ease-in-out infinite;
    }

    .animate-pulse-slow {
      animation: pulse 3s ease-in-out infinite;
    }

    .animate-shimmer {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }

    .bg-gradient-animated {
      background: linear-gradient(135deg, #6366F1, #A855F7, #EC4899, #00FFFF, #8B00FF);
      background-size: 200% 200%;
      animation: gradientShift 8s ease infinite;
    }

    .bg-gradient-home {
      background: linear-gradient(135deg, #FF5E6E, #00D6FF, #FF9800, #7C4DFF);
      background-size: 400% 400%;
      animation: gradientShift 12s ease infinite;
    }

    .animate-glow {
      animation: glow 2s ease-in-out infinite;
    }

    .animate-pulse-scale {
      animation: pulseScale 3s ease-in-out infinite;
    }

    .animate-rotate {
      animation: rotate 20s linear infinite;
    }

    .animate-slide {
      animation: slide 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-bounce {
      animation: bounce 2s infinite;
    }

    .animate-neon {
      animation: neonFlicker 2s ease-in-out infinite;
    }

    .animate-wave {
      animation: wave 3s ease-in-out infinite;
    }

    .animate-glow-text {
      animation: glowText 3s ease-in-out infinite;
    }

    /* 滚动条美化 */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* 消息动画 */
    .message-appear {
      animation: messageAppear 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes messageAppear {
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    /* 3D卡片效果 */
    .card-hover {
      transition: all 0.3s ease;
      transform-style: preserve-3d;
      perspective: 1000px;
    }

    .card-hover:hover {
      transform: translateY(-5px) rotateX(5deg);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }

    .card-hover::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      background: linear-gradient(135deg, #6366F1, #A855F7, #EC4899);
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
      filter: blur(4px);
    }

    .card-hover:hover::before {
      opacity: 1;
    }

    /* 新增的动画卡片效果 */
    .feature-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      overflow: hidden;
    }

    .feature-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .feature-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1), rgba(236, 72, 153, 0.1));
      z-index: 0;
      transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      transform: rotate(45deg);
    }

    .feature-card:hover::before {
      transform: rotate(45deg) translate(50px, -50px);
    }

    .feature-card-content {
      position: relative;
      z-index: 1;
    }

    /* === 新增炸裂动画 === */
    @keyframes textGlow {
      0%, 100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fff, 0 0 20px #00FFFF, 0 0 35px #00FFFF, 0 0 40px #00FFFF, 0 0 50px #00FFFF; }
      50% { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #00FFFF, 0 0 70px #00FFFF, 0 0 80px #00FFFF, 0 0 100px #00FFFF; }
    }

    @keyframes titleGlow {
      0%, 100% { text-shadow: 0 0 5px #FF9800, 0 0 10px #FF9800, 0 0 15px #FF9800, 0 0 20px #FF9800, 0 0 35px #FF9800, 0 0 40px #FF9800, 0 0 50px #FF9800; }
      50% { text-shadow: 0 0 10px #FF9800, 0 0 20px #FF9800, 0 0 30px #FF9800, 0 0 40px #FF9800, 0 0 70px #FF9800, 0 0 80px #FF9800, 0 0 100px #FF9800; }
    }

    @keyframes subtitleGlow {
      0%, 100% { text-shadow: 0 0 5px #8B00FF, 0 0 10px #8B00FF, 0 0 15px #8B00FF, 0 0 20px #8B00FF, 0 0 35px #8B00FF, 0 0 40px #8B00FF, 0 0 50px #8B00FF; }
      50% { text-shadow: 0 0 10px #8B00FF, 0 0 20px #8B00FF, 0 0 30px #8B00FF, 0 0 40px #8B00FF, 0 0 70px #8B00FF, 0 0 80px #8B00FF, 0 0 100px #8B00FF; }
    }

    @keyframes floatingShapes {
      0% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
      100% { transform: translateY(0) rotate(360deg); }
    }

    /* === 聊天页面彩带 === */
    @keyframes ribbonFall {
      0% { transform: translateY(-100vh) translateX(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) translateX(50px) rotate(360deg); opacity: 0.3; }
    }

    .ribbon {
      position: absolute;
      width: 2px;
      background: linear-gradient(to bottom, transparent, #00FFFF, #8B00FF, transparent);
      opacity: 0.6;
      animation: ribbonFall 15s linear infinite;
      z-index: 0;
    }

    .text-glow-cyan {
      animation: textGlow 3s ease-in-out infinite;
    }

    .text-glow-orange {
      animation: titleGlow 3s ease-in-out infinite;
    }

    .text-glow-purple {
      animation: subtitleGlow 3s ease-in-out infinite;
    }

    /* 代码块和数学公式样式 */
    pre, .math-container {
      white-space: pre !important;
      word-break: normal;
      overflow-x: auto;
      background-color: #16181D !important;
      padding: 1rem !important;
      border-radius: 0.75rem !important;
      margin: 0.75rem 0 !important;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
    }

    pre:hover, .math-container:hover {
      border-color: rgba(99, 102, 241, 0.3);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    code {
      font-family: 'Fira Code', monospace !important;
      font-size: 0.875rem !important;
      line-height: 1.6 !important;
    }

    /* 复制按钮样式 */
    .copy-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: rgba(255, 255, 255, 0.08);
      color: #fff;
      border: none;
      border-radius: 0.375rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      z-index: 5;
      opacity: 0;
    }

    pre:hover .copy-btn, .math-container:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover { 
      background-color: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .copy-btn.copied { 
      background-color: #10b981;
      transform: translateY(-2px);
    }

    .copy-btn.failed { 
      background-color: #ef4444;
      transform: translateY(-2px);
    }

    /* Markdown 元素样式 */
    .markdown-heading { 
      font-weight: bold; 
      margin: 1em 0 0.5em; 
      color: #6366F1;
    }

    .markdown-list { 
      margin: 0.5em 0 0.5em 1.5em; 
    }

    .markdown-list li { 
      margin: 0.3em 0; 
    }

    .error-message {
      color: #ef4444 !important;
      background-color: rgba(239, 68, 68, 0.1) !important;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
      padding: 1rem !important;
      border-radius: 0.75rem !important;
    }

    /* 打字动画 */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0;
    }

    .typing-indicator span {
      width: 0.75rem;
      height: 0.75rem;
      background-color: #6366F1;
      border-radius: 50%;
      display: inline-block;
      animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  </style>
</head>
<body class="bg-dark text-text-light font-inter min-h-screen flex flex-col">
  <!-- 粒子背景容器 -->
  <div id="particleContainer"></div>

  <!-- 彩带容器 -->
  <div id="ribbonContainer"></div>

  <!-- 全新首页 -->
  <div id="homePage" class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-black via-blue-900/30 to-purple-900/30 p-4 transition-all duration-700 relative z-10 overflow-hidden">
    <!-- 动态背景层 -->
    <div class="absolute inset-0">
      <div class="wave-bg"></div>
      <div class="wave-bg" style="animation-delay: -10s; opacity: 0.3;"></div>
      <div class="wave-bg" style="animation-delay: -5s; opacity: 0.2;"></div>
    </div>

    <!-- 星点背景 -->
    <div class="absolute inset-0" id="starField"></div>

    <!-- 浮动粒子 -->
    <div class="absolute inset-0" id="floatingParticles"></div>

    <!-- 脉冲环 -->
    <div class="absolute top-1/2 left-1/2 w-96 h-96">
      <div class="pulse-ring w-full h-full"></div>
      <div class="pulse-ring w-full h-full" style="animation-delay: 1s;"></div>
      <div class="pulse-ring w-full h-full" style="animation-delay: 2s;"></div>
    </div>

    <!-- 浮动装饰形状 -->
    <div class="absolute top-10 left-10 w-20 h-20 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full opacity-20 animate-pulse animate-float" style="animation-delay: 0s;"></div>
    <div class="absolute top-20 right-20 w-16 h-16 bg-gradient-to-r from-orange-400 to-red-500 rounded-lg opacity-20 animate-pulse animate-float" style="animation-delay: 2s;"></div>
    <div class="absolute bottom-20 left-20 w-12 h-12 bg-gradient-to-r from-green-400 to-teal-500 rounded-full opacity-20 animate-pulse animate-float" style="animation-delay: 4s;"></div>
    <div class="absolute bottom-10 right-10 w-24 h-24 bg-gradient-to-r from-purple-400 to-pink-500 rounded-lg opacity-20 animate-pulse animate-float" style="animation-delay: 6s;"></div>

    <div class="text-center mb-12 max-w-4xl relative z-10">
      <!-- 3D Logo -->
      <div class="flex items-center justify-center mb-8">
        <div class="card-3d bg-gradient-animated w-32 h-32 rounded-full flex items-center justify-center shadow-glow-xl animate-pulse-scale">
          <i class="fa fa-comments text-white text-4xl animate-wave"></i>
        </div>
      </div>
      
      <!-- 主标题（调暗） -->
      <h1 class="text-[clamp(2.5rem,8vw,5rem)] sm:text-[clamp(3rem,10vw,6rem)] font-extrabold mb-6 leading-tight">
        <span class="text-white neon-text-dim font-black drop-shadow-2xl">
          LJY-GLM-4-Flash
        </span>
      </h1>
      
      <!-- 副标题 -->
      <p class="text-gray-300 text-lg sm:text-xl md:text-2xl mb-8 max-w-3xl mx-auto text-glow-purple font-bold">
        探索无限可能，释放创意潜能
      </p>
      
      <!-- 功能卡片网格 -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-12 z-10 max-w-5xl mx-auto">
        <div class="feature-card animate-slide" style="animation-delay: 0.1s;">
          <div class="feature-card-content">
            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-2xl flex items-center justify-center mb-3 sm:mb-4 animate-bounce">
              <i class="fa fa-bolt text-white text-xl sm:text-2xl"></i>
            </div>
            <h3 class="text-lg sm:text-2xl font-semibold mb-1 sm:mb-2 text-white text-glow-cyan">⚡ 极速响应</h3>
            <p class="text-gray-300 font-medium text-sm sm:text-base">毫秒级AI响应，零延迟体验</p>
          </div>
        </div>
        
        <div class="feature-card animate-slide" style="animation-delay: 0.2s;">
          <div class="feature-card-content">
            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-r from-orange-400 to-red-500 rounded-2xl flex items-center justify-center mb-3 sm:mb-4 animate-bounce">
              <i class="fa fa-code text-white text-xl sm:text-2xl"></i>
            </div>
            <h3 class="text-lg sm:text-2xl font-semibold mb-1 sm:mb-2 text-white text-glow-orange">💻 智能代码</h3>
            <p class="text-gray-300 font-medium text-sm sm:text-base">一键复制，高亮显示，支持多种语言</p>
          </div>
        </div>
        
        <div class="feature-card animate-slide" style="animation-delay: 0.3s;">
          <div class="feature-card-content">
            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-r from-green-400 to-teal-500 rounded-2xl flex items-center justify-center mb-3 sm:mb-4 animate-bounce">
              <i class="fa fa-calculator text-white text-xl sm:text-2xl"></i>
            </div>
            <h3 class="text-lg sm:text-2xl font-semibold mb-1 sm:mb-2 text-white text-glow-purple">🔢 数学公式</h3>
            <p class="text-gray-300 font-medium text-sm sm:text-base">完美LaTeX渲染，数学表达无压力</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 开始按钮和版权分开 -->
    <div class="relative z-10 flex flex-col items-center space-y-6">
      <button id="startChatBtn" class="bg-gradient-animated hover:shadow-glow-xl text-white font-bold py-4 px-12 sm:py-5 sm:px-20 rounded-full text-lg sm:text-2xl shadow-lg btn-pop focus:outline-none focus:ring-4 focus:ring-primary/30 animate-slide">
        <i class="fa fa-rocket mr-2 sm:mr-3"></i>开始对话
      </button>
      
      <p class="text-gray-300 text-xs sm:text-sm animate-slide font-medium">
        © 2025 LJY-GLM-4-Flash | 智能对话系统
      </p>
    </div>
  </div>

  <!-- 聊天界面 (初始隐藏) -->
  <div id="chatPage" class="hidden flex-1 flex flex-col h-screen relative z-10 overflow-hidden">
    <!-- 彩带背景 -->
    <div id="chatRibbons" class="absolute inset-0 pointer-events-none"></div>
    
    <!-- 装饰背景 -->
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(99,102,241,0.2)_0%,transparent_40%),radial-gradient(circle_at_80%_80%,rgba(168,85,247,0.2)_0%,transparent_40%)] pointer-events-none"></div>
    <div class="absolute inset-0 bg-gradient-to-b from-primary/5 via-secondary/5 to-accent/5 opacity-10 pointer-events-none animate-pulse-slow"></div>
    
    <!-- 增强装饰元素 -->
    <div class="absolute inset-0">
      <div class="absolute top-0 left-0 w-1/2 h-1/2 bg-gradient-to-r from-primary/10 to-transparent opacity-30 rounded-br-full animate-pulse-slow" style="animation-delay: 0.2s;"></div>
      <div class="absolute bottom-0 right-0 w-1/2 h-1/2 bg-gradient-to-l from-secondary/10 to-transparent opacity-30 rounded-tl-full animate-pulse-slow" style="animation-delay: 0.5s;"></div>
      <div class="absolute bottom-0 left-0 w-1/3 h-1/3 bg-gradient-to-r from-accent/10 to-transparent opacity-30 rounded-tr-full animate-pulse-slow" style="animation-delay: 0.8s;"></div>
    </div>

    <!-- 聊天头部（固定） -->
    <header class="glass-effect p-3 sm:p-4 flex items-center justify-between shadow-lg z-20 bg-[rgba(30,31,38,0.95)] backdrop-blur-md" style="position: fixed; top: 0; left: 0; right: 0; height: 64px;">
      <div class="flex items-center">
        <div class="bg-gradient-animated w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center mr-2 sm:mr-3 shadow-glow/50">
          <i class="fa fa-robot text-white text-base sm:text-xl"></i>
        </div>
        <h1 class="text-base sm:text-xl font-bold tracking-tight">
          <span class="bg-gradient-to-r from-primary to-secondary text-gradient animate-glow-text">GLM-4-Flash</span>
        </h1>
      </div>
      
      <div class="flex space-x-2 sm:space-x-4">
        <button id="newChatBtn" class="text-gray-400 hover:text-white transition-colors p-1.5 sm:p-2 rounded-full hover:bg-white/10 glass-hover">
          <i class="fa fa-plus"></i>
        </button>
        <button id="backBtn" class="text-gray-400 hover:text-white transition-colors p-1.5 sm:p-2 rounded-full hover:bg-white/10 glass-hover">
          <i class="fa fa-arrow-left"></i>
        </button>
        <button id="cancelBtn" class="text-gray-400 hover:text-white transition-colors p-1.5 sm:p-2 rounded-full hover:bg-white/10 glass-hover hidden">
          <i class="fa fa-times"></i>
        </button>
      </div>
    </header>
    
    <!-- 聊天内容区 -->
    <div id="chatContainer" class="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6 custom-scrollbar relative" style="padding-top: 80px; padding-bottom: 150px;">
      <div id="messages" class="space-y-4 sm:space-y-6 max-w-4xl mx-auto relative z-10">
        <!-- 系统消息 -->
        <div class="flex items-start message-appear">
          <div class="bg-gradient-animated w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center mr-2 sm:mr-4 flex-shrink-0 shadow-glow/50">
            <i class="fa fa-info text-white"></i>
          </div>
          <div class="bg-dark-light rounded-xl sm:rounded-2xl p-3 sm:p-5 shadow-lg max-w-[85%] sm:max-w-[90%] border border-white/5 transition-all duration-300 hover:border-primary/20">
            <p class="text-gray-300 text-sm sm:text-base leading-relaxed">欢迎使用 GLM-4-Flash 对话系统！我是您的 AI 助手，能够帮助您解决问题、提供信息和创意灵感。</p>
            <p class="text-xs text-gray-500 mt-1 sm:mt-2">系统消息 · 刚刚</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 输入区域（固定） -->
    <footer class="glass-effect p-3 sm:p-4 md:p-6 shadow-inner fixed bottom-0 left-0 right-0 bg-[rgba(30,31,38,0.95)] backdrop-blur-md border-t border-white/10">
      <div class="max-w-4xl mx-auto">
        <div class="relative">
          <textarea id="userInput" placeholder="输入您的问题... (支持Markdown、代码块和LaTeX公式)" class="w-full bg-dark-lighter text-black border border-gray-700/50 rounded-xl sm:rounded-2xl p-3 sm:p-4 pr-12 sm:pr-16 focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none transition-all duration-300 min-h-[60px] sm:min-h-[80px] max-h-[100px] sm:max-h-[120px] hover:border-primary/30 placeholder-gray-400 text-sm sm:text-base"></textarea>
          
          <div class="absolute right-2 bottom-2 sm:right-3 sm:bottom-3 flex space-x-1 sm:space-x-2">
            <button id="attachmentBtn" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full transition-all duration-300 btn-pop flex items-center justify-center">
              <i class="fa fa-paperclip text-sm sm:text-base"></i>
            </button>
            <button id="sendBtn" class="bg-gradient-animated hover:shadow-glow text-white p-2 rounded-full transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed btn-pop flex items-center justify-center">
              <i class="fa fa-paper-plane text-sm sm:text-base"></i>
            </button>
          </div>
        </div>
        
        <div class="flex flex-wrap justify-between items-center mt-2 sm:mt-3 text-xs text-gray-500 gap-2">
          <div class="flex items-center space-x-2 sm:space-x-4">
            <span class="flex items-center transition-colors hover:text-primary"><i class="fa fa-code mr-1"></i> 代码块</span>
            <span class="flex items-center transition-colors hover:text-primary"><i class="fa fa-calculator mr-1"></i> LaTeX</span>
            <span class="flex items-center transition-colors hover:text-primary"><i class="fa fa-file-text-o mr-1"></i> 文件上传</span>
          </div>
          <div id="charCount" class="flex items-center">
            <i class="fa fa-file-text-o mr-1"></i> 0/2000
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // 增强版粒子背景效果
    function createEnhancedBackground() {
      const container = document.getElementById('particleContainer');
      
      // 创建星点
      const starField = document.getElementById('starField');
      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star-field';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (Math.random() * 3 + 2) + 's';
        starField.appendChild(star);
      }
      
      // 创建浮动粒子
      const floatingParticles = document.getElementById('floatingParticles');
      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'floating-particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 10 + 's';
        particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
        floatingParticles.appendChild(particle);
      }
      
      // 创建粒子背景
      const particleCount = 200;
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        
        const size = Math.random() * 6 + 2;
        const posX = Math.random() * 100;
        const posY = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = Math.random() * 35 + 25;
        const opacity = Math.random() * 0.6 + 0.2;
        
        const colors = ['#00FFFF', '#FF9800', '#8B00FF', '#00D6FF', '#A855F7', '#EC4899'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        particle.style.cssText = `
          position: absolute;
          width: ${size}px;
          height: ${size}px;
          background: radial-gradient(circle, ${color}, transparent);
          border-radius: 50%;
          top: ${posY}%;
          left: ${posX}%;
          opacity: ${opacity};
          animation: float ${duration}s ease-in-out ${delay}s infinite;
          pointer-events: none;
          box-shadow: 0 0 ${size * 3}px ${color};
        `;
        
        container.appendChild(particle);
      }
      
      // 添加视差效果
      document.addEventListener('mousemove', (e) => {
        const particles = container.querySelectorAll('.floating-particle');
        const mouseX = e.clientX / window.innerWidth - 0.5;
        const mouseY = e.clientY / window.innerHeight - 0.5;
        
        particles.forEach((particle, index) => {
          const depth = index % 10 / 10;
          const moveX = mouseX * 100 * depth;
          const moveY = mouseY * 100 * depth;
          
          particle.style.transform = `translate(${moveX}px, ${moveY}px)`;
        });
      });
    }
    
    // 创建聊天页面彩带
    function createChatRibbons() {
      const ribbonContainer = document.getElementById('chatRibbons');
      const colors = ['#00FFFF', '#FF9800', '#8B00FF', '#00D6FF', '#A855F7', '#EC4899'];
      
      for (let i = 0; i < 20; i++) {
        const ribbon = document.createElement('div');
        ribbon.className = 'ribbon';
        
        const height = Math.random() * 300 + 100;
        const left = Math.random() * 100;
        const delay = Math.random() * 15;
        const duration = Math.random() * 10 + 15;
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        ribbon.style.height = `${height}px`;
        ribbon.style.left = `${left}%`;
        ribbon.style.animationDelay = `${delay}s`;
        ribbon.style.animationDuration = `${duration}s`;
        ribbon.style.background = `linear-gradient(to bottom, transparent, ${color}, transparent)`;
        
        ribbonContainer.appendChild(ribbon);
      }
    }
    
    // 初始化增强背景
    createEnhancedBackground();
    createChatRibbons();
    
    // DOM元素引用
    const homePage = document.getElementById('homePage');
    const chatPage = document.getElementById('chatPage');
    const startChatBtn = document.getElementById('startChatBtn');
    const backBtn = document.getElementById('backBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const messages = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const charCount = document.getElementById('charCount');
    const chatContainer = document.getElementById('chatContainer');
    const attachmentBtn = document.getElementById('attachmentBtn');
    
    // 状态变量
    let isStreaming = false;
    let controller = null;
    let conversationHistory = [];
    let streamBuffer = '';
    
    // 页面切换动画
    startChatBtn.addEventListener('click', () => {
      homePage.classList.add('opacity-0', 'scale-95');
      homePage.style.pointerEvents = 'none';
      
      setTimeout(() => {
        homePage.classList.add('hidden');
        chatPage.classList.remove('hidden');
        chatPage.classList.add('opacity-0', 'scale-95');
        
        setTimeout(() => {
          chatPage.classList.remove('opacity-0', 'scale-95');
          
          // 添加进入动画
          const chatElements = chatPage.querySelectorAll('header, #chatContainer, footer');
          chatElements.forEach((el, index) => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            setTimeout(() => {
              el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
              el.style.opacity = '1';
              el.style.transform = 'translateY(0)';
            }, index * 100);
          });
          
          setTimeout(() => {
            userInput.focus();
          }, 300);
        }, 50);
      }, 500);
    });
    
    backBtn.addEventListener('click', () => {
      const chatElements = chatPage.querySelectorAll('header, #chatContainer, footer');
      chatElements.forEach((el, index) => {
        setTimeout(() => {
          el.style.opacity = '0';
          el.style.transform = 'translateY(20px)';
        }, index * 100);
      });
      
      setTimeout(() => {
        chatPage.classList.add('opacity-0', 'scale-95');
        chatPage.style.pointerEvents = 'none';
        
        setTimeout(() => {
          chatPage.classList.add('hidden');
          homePage.classList.remove('hidden', 'opacity-0', 'scale-95');
          homePage.style.pointerEvents = 'auto';
        }, 500);
      }, 300);
    });
    
    // 新建对话
    newChatBtn.addEventListener('click', () => {
      if (isStreaming && controller) controller.abort();
      
      // 添加删除动画
      const messageElements = messages.querySelectorAll('.message-appear');
      messageElements.forEach((el, index) => {
        setTimeout(() => {
          el.style.opacity = '0';
          el.style.transform = 'translateY(10px)';
          el.style.height = el.offsetHeight + 'px';
          
          setTimeout(() => {
            el.style.height = '0';
            el.style.margin = '0';
            el.style.padding = '0';
            el.style.overflow = 'hidden';
            el.style.opacity = '0';
            
            if (index === messageElements.length - 1) {
              setTimeout(() => {
                resetChat();
              }, 300);
            }
          }, 300);
        }, index * 50);
      });
    });
    
    function resetChat() {
      messages.innerHTML = `
        <div class="flex items-start message-appear">
          <div class="bg-gradient-animated w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center mr-2 sm:mr-4 flex-shrink-0 shadow-glow/50">
            <i class="fa fa-info text-white"></i>
          </div>
          <div class="bg-dark-light rounded-xl sm:rounded-2xl p-3 sm:p-5 shadow-lg max-w-[85%] sm:max-w-[90%] border border-white/5 transition-all duration-300 hover:border-primary/20">
            <p class="text-gray-300 text-sm sm:text-base leading-relaxed">欢迎使用 GLM-4-Flash 对话系统！我是您的 AI 助手，能够帮助您解决问题、提供信息和创意灵感。</p>
            <p class="text-xs text-gray-500 mt-1 sm:mt-2">系统消息 · 刚刚</p>
          </div>
        </div>
      `;
      conversationHistory = [];
      cancelBtn.classList.add('hidden');
      streamBuffer = '';
    }
    
    // 取消请求
    cancelBtn.addEventListener('click', () => {
      if (isStreaming && controller) {
        controller.abort();
        addSystemMessage("已取消生成响应");
      }
    });
    
    // 字符计数
    userInput.addEventListener('input', () => {
      const count = userInput.value.length;
      charCount.innerHTML = `<i class="fa fa-file-text-o mr-1"></i> ${count}/2000`;
      
      if (count > 2000) {
        charCount.classList.add('text-red-500');
        sendBtn.disabled = true;
      } else {
        charCount.classList.remove('text-red-500');
        sendBtn.disabled = false;
      }
      
      // 自动调整文本框高度
      userInput.style.height = 'auto';
      userInput.style.height = (Math.min(userInput.scrollHeight, 120)) + 'px';
    });
    
    // 附件按钮
    attachmentBtn.addEventListener('click', () => {
      // 添加按钮点击反馈动画
      attachmentBtn.classList.add('scale-90');
      setTimeout(() => {
        attachmentBtn.classList.remove('scale-90');
        
        // 创建文件上传功能
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.txt,.docx';
        
        input.onchange = async (e) => {
          if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            let text = '';
            
            try {
              if (file.type === 'text/plain') {
                text = await file.text();
              } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                if (window.mammoth) {
                  const result = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
                  text = result.value;
                } else {
                  throw new Error('DOCX解析库未加载');
                }
              } else {
                throw new Error('不支持的文件类型');
              }
              
              addMessage('user', `上传的文件内容:\n${text.substring(0, 500)}${text.length > 500 ? '...' : ''}`);
              conversationHistory.push({ role: 'user', content: text });
              
              const aiMessageId = addThinkingMessage();
              fetchChatGPTResponse(conversationHistory, aiMessageId);
            } catch (error) {
              addSystemMessage(`文件读取错误: ${error.message}`);
            }
          }
        };
        
        input.click();
      }, 150);
    });
    
    // 发送消息
    function sendMessage() {
      const message = userInput.value.trim();
      if (!message || isStreaming) return;
      
      addMessage('user', message);
      conversationHistory.push({ role: 'user', content: message });
      
      // 清空输入框并重置高度
      userInput.value = '';
      userInput.style.height = 'auto';
      userInput.style.height = '80px';
      charCount.innerHTML = '<i class="fa fa-file-text-o mr-1"></i> 0/2000';
      
      cancelBtn.classList.remove('hidden');
      
      const aiMessageId = addThinkingMessage();
      fetchChatGPTResponse(conversationHistory, aiMessageId);
    }
    
    // 添加系统消息
    function addSystemMessage(content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start message-appear';
      messageDiv.style.animationDelay = '0.1s';
      messageDiv.innerHTML = `
        <div class="bg-yellow-600 w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center mr-2 sm:mr-4 flex-shrink-0 animate-pulse-slow">
          <i class="fa fa-exclamation-circle text-white"></i>
        </div>
        <div class="bg-dark-light rounded-xl sm:rounded-2xl p-3 sm:p-5 shadow-lg max-w-[85%] sm:max-w-[90%] border border-white/5 transition-all duration-300 hover:border-yellow-500/20">
          <p class="text-yellow-300 text-sm sm:text-base">${content}</p>
          <p class="text-xs text-gray-500 mt-1 sm:mt-2">系统 · 刚刚</p>
        </div>
      `;
      messages.appendChild(messageDiv);
      scrollToBottom();
      return messageDiv;
    }
    
    // 事件监听
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // 添加消息到聊天界面
    function addMessage(role, content, messageId = null) {
      const isUser = role === 'user';
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start message-appear';
      if (messageId) messageDiv.id = messageId;
      
      // 错开动画延迟，创造连续感
      const messagesCount = messages.querySelectorAll('.message-appear').length;
      messageDiv.style.animationDelay = `${messagesCount * 0.05}s`;
      
      const iconClass = isUser ? 'fa-user' : 'fa-robot';
      const iconBgClass = isUser ? 'bg-dark-lighter border border-primary/30' : 'bg-gradient-animated shadow-glow/50'
      
      messageDiv.innerHTML = `
        <div class="${isUser ? 'order-2 ml-2 sm:ml-4' : 'order-1'} ${iconBgClass} w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center flex-shrink-0">
          <i class="fa ${iconClass} text-white text-sm sm:text-base"></i>
        </div>
        <div class="${isUser ? 'order-1 ml-auto' : 'order-2'} max-w-[85%] sm:max-w-[90%]">
          <div class="${isUser ? 'bg-primary/15 border border-primary/20' : 'bg-dark-light border border-white/5'} rounded-xl sm:rounded-2xl p-3 sm:p-5 shadow-lg transition-all duration-300 hover:shadow-xl transform hover:-translate-y-0.5">
            <div class="prose prose-invert max-w-none">
              ${formatMessage(content)}
            </div>
            <p class="text-xs text-gray-500 mt-1 sm:mt-2">
              ${isUser ? '你 · 刚刚' : 'GLM-4-Flash · 正在生成...'}
            </p>
          </div>
        </div>
      `;
      
      messages.appendChild(messageDiv);
      scrollToBottom();
      
      if (!isUser) {
        renderCodeBlocks(messageDiv);
      } else {
        renderMathInElement(messageDiv);
      }
      
      return messageDiv;
    }
    
    // 添加思考中消息
    function addThinkingMessage() {
      const messageId = `message-${Date.now()}`;
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start message-appear';
      messageDiv.id = messageId;
      
      const messagesCount = messages.querySelectorAll('.message-appear').length;
      messageDiv.style.animationDelay = `${messagesCount * 0.05}s`;
      
      messageDiv.innerHTML = `
        <div class="order-1 bg-gradient-animated w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center mr-2 sm:mr-4 flex-shrink-0 shadow-glow/50">
          <i class="fa fa-robot text-white"></i>
        </div>
        <div class="order-2 max-w-[85%] sm:max-w-[90%]">
          <div class="bg-dark-light border border-white/5 rounded-xl sm:rounded-2xl p-3 sm:p-5 shadow-lg transition-all duration-300 hover:shadow-xl">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <p class="text-xs text-gray-500 mt-1 sm:mt-2">GLM-4-Flash · 正在生成...</p>
          </div>
        </div>
      `;
      
      messages.appendChild(messageDiv);
      scrollToBottom();
      return messageId;
    }
    
    // 格式化消息内容
    function formatMessage(content) {
      const tempDiv = document.createElement('div');
      let parts = splitContentIntoParts(content);
      let processedParts = [];
      
      parts.forEach(part => {
        if (part.isCode) {
          processedParts.push(part);
        } else {
          processedParts.push(...splitMathExpressions(part.content));
        }
      });
      
      let formatted = '';
      processedParts.forEach(part => {
        if (part.isCode) {
          let { lang, code } = part;
          lang = lang || 'plaintext';
          const escapedCode = code
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
          formatted += `<pre><code class="language-${lang}">${escapedCode}</code></pre>`;
        } else if (part.isMath) {
          tempDiv.textContent = part.content;
          formatted += `<div class="math-container">${tempDiv.innerHTML}</div>`;
        } else {
          let text = part.content;
          tempDiv.textContent = text;
          text = tempDiv.innerHTML;
          
          // 处理Markdown格式
          text = text
            .replace(/`([^`]+)`/g, (match, code) => {
              const escapedCode = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
              return `<code class="bg-dark-lighter px-1 py-0.5 rounded text-sm">${escapedCode}</code>`;
            })
            .replace(/^(#{1,6})\s+(.*?)$/gm, (match, hashes, titleText) => 
              `<h${hashes.length} class="markdown-heading text-lg sm:text-xl">${titleText}</h${hashes.length}>`
            )
            .replace(/^[-*+]\s+(.*?)$/gm, '<li>$1</li>')
            .replace(/(<li>.*?<\/li>)\s+(?=<li>)/gs, '$1')
            .replace(/(<li>.*?<\/li>)/gs, '<ul class="markdown-list">$&</ul>')
            .replace(/^(\d+)\.\s+(.*?)$/gm, '<li>$2</li>')
            .replace(/(<li>.*?<\/li>)/gs, '<ol class="markdown-list">$&</ol>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-primary hover:underline" target="_blank">$1</a>')
            .replace(/\n/g, '<br>');
          
          formatted += text;
        }
      });
      
      return formatted;
    }
    
    // 分割内容为代码块和非代码块部分
    function splitContentIntoParts(content) {
      const parts = [];
      const codeBlockRegex = /```([a-zA-Z0-9]*)\r?\n([\s\S]*?)\r?\n```/g;
      let lastIndex = 0;
      let match;
      
      while ((match = codeBlockRegex.exec(content)) !== null) {
        if (match.index > lastIndex) {
          parts.push({
            isCode: false,
            isMath: false,
            content: content.substring(lastIndex, match.index)
          });
        }
        
        parts.push({
          isCode: true,
          isMath: false,
          lang: match[1],
          code: match[2]
        });
        
        lastIndex = codeBlockRegex.lastIndex;
      }
      
      if (lastIndex < content.length) {
        parts.push({
          isCode: false,
          isMath: false,
          content: content.substring(lastIndex)
        });
      }
      
      return parts;
    }
    
    // 分割数学公式
    function splitMathExpressions(content) {
      const parts = [];
      const blockMathRegex = /(\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\])/g;
      let lastIndex = 0;
      let match;
      
      while ((match = blockMathRegex.exec(content)) !== null) {
        if (match.index > lastIndex) {
          parts.push({
            isCode: false,
            isMath: false,
            content: content.substring(lastIndex, match.index)
          });
        }
        
        parts.push({
          isCode: false,
          isMath: true,
          content: match[0]
        });
        
        lastIndex = blockMathRegex.lastIndex;
      }
      
      if (lastIndex < content.length) {
        parts.push({
          isCode: false,
          isMath: false,
          content: content.substring(lastIndex)
        });
      }
      
      return parts;
    }
    
    // 渲染代码块
    function renderCodeBlocks(container) {
      requestAnimationFrame(() => {
        container.querySelectorAll('pre').forEach((preBlock) => {
          const codeBlock = preBlock.querySelector('code');
          let code = codeBlock.textContent
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/>/g, '>');
          
          codeBlock.textContent = code;
          
          // 仅在hljs加载完成后执行
          if (window.hljs) {
            hljs.highlightElement(codeBlock);
          }
          
          // 创建复制按钮
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-btn';
          copyBtn.innerHTML = '<i class="fa fa-copy"></i> 复制';
          const originalHTML = copyBtn.innerHTML;
          const originalClass = copyBtn.className;
          
          copyBtn.addEventListener('click', () => {
            // 按钮点击反馈
            copyBtn.classList.add('scale-90');
            setTimeout(() => copyBtn.classList.remove('scale-90'), 150);
            
            if (navigator.clipboard) {
              navigator.clipboard.writeText(code).then(() => {
                showCopySuccess(copyBtn, originalHTML, originalClass);
              }).catch(() => {
                fallbackCopyMethod(code, copyBtn, originalHTML, originalClass);
              });
            } else {
              fallbackCopyMethod(code, copyBtn, originalHTML, originalClass);
            }
          });
          
          preBlock.appendChild(copyBtn);
        });
      });
    }
    
    // 复制反馈函数
    function showCopySuccess(btn, originalHTML, originalClass) {
      btn.innerHTML = '<i class="fa fa-check"></i> 已复制';
      btn.className = originalClass + ' copied';
      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.className = originalClass;
      }, 2000);
    }
    
    function showCopyFailed(btn, originalHTML, originalClass) {
      btn.innerHTML = '<i class="fa fa-times"></i> 失败';
      btn.className = originalClass + ' failed';
      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.className = originalClass;
      }, 2000);
    }
    
    // 备用复制方法
    function fallbackCopyMethod(text, btn, originalHTML, originalClass) {
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
          showCopySuccess(btn, originalHTML, originalClass);
        } else {
          throw new Error();
        }
      } catch {
        showCopyFailed(btn, originalHTML, originalClass);
      }
    }
    
    // 渲染数学公式
    function renderMathInElement(element) {
      if (window.MathJax && window.MathJax.typeset) {
        window.MathJax.typesetPromise([element])
          .then(() => {
            setTimeout(() => {
              window.MathJax.typesetPromise([element]).catch(err => console.error('MathJax渲染错误:', err));
            }, 300);
          })
          .catch(err => {
            console.error('MathJax渲染错误:', err);
            window.MathJax.typesetPromise([element]).catch(err => console.error('MathJax渲染错误:', err));
          });
      }
    }
    
    // 滚动到底部
function scrollToBottom() {
  requestAnimationFrame(() => {
    chatContainer.scrollTop = chatContainer.scrollHeight;
    // 确保最后一条消息可见
    const lastMessage = messages.lastElementChild;
    if (lastMessage) {
      lastMessage.scrollIntoView({ behavior: 'auto', block: 'end' });
    }
  });
}
    
    // 自动滚动到底部
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
          scrollToBottom();
        }
      });
    });
    
    observer.observe(messages, { childList: true, subtree: true });
    
    // 获取GLM-4-Flash响应
    async function fetchChatGPTResponse(history, aiMessageId) {
      isStreaming = true;
      sendBtn.disabled = true;
      streamBuffer = '';
      
      controller = new AbortController();
      const signal = controller.signal;
      
      try {
        const myHeaders = new Headers();
        myHeaders.append("Authorization", "Bearer e4e8b6da7f6c467ebeaffa6932de7648.YSfrQRvutMySA4yo");
        myHeaders.append("Content-Type", "application/json");
        
        const raw = JSON.stringify({
          "model": "glm-4-flash-250414",
          "messages": history,
          "stream": true,
          "max_tokens": 8080
        });
        
        const requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow',
          signal: signal
        };
        
        // 超时控制
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('请求超时，请重试')), 300000)
        );
        
        const response = await Promise.race([
          fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", requestOptions),
          timeoutPromise
        ]);
        
        if (!response.ok) {
          let errorDetails = `HTTP错误: ${response.status}`;
          try {
            const errorData = await response.json();
            errorDetails = errorData.error?.message || errorDetails;
          } catch {}
          throw new Error(errorDetails);
        }
        
        // 处理流式响应
        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let fullContent = '';
        let lastRenderTime = 0;
        const renderInterval = 50;
        
        // 移除打字动画，准备显示内容
        const aiMessageElement = document.getElementById(aiMessageId);
        const contentContainer = aiMessageElement.querySelector('.bg-dark-light');
        contentContainer.innerHTML = `
          <div class="prose prose-invert max-w-none" id="streaming-content-${aiMessageId}"></div>
          <p class="text-xs text-gray-500 mt-1 sm:mt-2">GLM-4-Flash · 正在生成...</p>
        `;
        const contentElement = document.getElementById(`streaming-content-${aiMessageId}`);
        const timestampElement = aiMessageElement.querySelector('.text-gray-500');
        
        // 流式处理循环
        while (true) {
          const { done, value } = await reader.read();
          
          if (value) streamBuffer += decoder.decode(value, { stream: true });
          
          // 处理缓冲区中的完整行
          let lineEndIndex;
          while ((lineEndIndex = streamBuffer.indexOf('\n')) !== -1) {
            const line = streamBuffer.substring(0, lineEndIndex).trim();
            streamBuffer = streamBuffer.substring(lineEndIndex + 1);
            
            if (line === '' || line === 'data: [DONE]') continue;
            
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(5));
                if (data.choices?.[0]?.delta?.content) {
                  fullContent += data.choices[0].delta.content;
                  
                  // 控制渲染频率
                  const now = Date.now();
                  if (now - lastRenderTime > renderInterval) {
                    contentElement.innerHTML = formatMessage(fullContent);
              renderCodeBlocks(aiMessageElement);
              lastRenderTime = now;
              scrollToBottom();
                  }
                }
              } catch (e) {
                console.error('解析响应错误:', e);
              }
            }
          }
          
          if (done) {
            contentElement.innerHTML = formatMessage(fullContent);
            renderCodeBlocks(aiMessageElement);
            renderMathInElement(contentElement);
            scrollToBottom();
            break;
          }
        }
        
        timestampElement.textContent = 'GLM-4-Flash · 已完成';
        conversationHistory.push({ role: 'assistant', content: fullContent });
        
      } catch (error) {
        console.error('请求错误:', error);
        const aiMessageElement = document.getElementById(aiMessageId);
        if (aiMessageElement) {
          const contentContainer = aiMessageElement.querySelector('.bg-dark-light');
          contentContainer.innerHTML = `
            <div class="prose prose-invert max-w-none">
              <p class="error-message">${error.message}</p>
            </div>
            <p class="text-xs text-gray-500 mt-1 sm:mt-2">GLM-4-Flash · 错误</p>
          `;
        } else {
          addSystemMessage(`错误: ${error.message}`);
        }
      } finally {
        isStreaming = false;
        sendBtn.disabled = false;
        cancelBtn.classList.add('hidden');
        controller = null;
        streamBuffer = '';
        scrollToBottom();
      }
    }
    
    // 初始化输入框高度
    window.addEventListener('load', () => {
      userInput.style.height = 'auto';
      userInput.style.height = '80px';
      
      // 页面加载动画
      document.body.classList.add('opacity-0');
      setTimeout(() => {
        document.body.style.transition = 'opacity 1s ease';
        document.body.classList.remove('opacity-0');
      }, 100);
    });
  </script>
</body>
</html>